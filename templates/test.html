<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://maps.api.2gis.ru/2.0/loader.js?pkg=full"></script>

    <script>
        var map;

        DG.then(function () {
            map = DG.map('map', {
                center: [55.565029, 37.452288],
                zoom: 13
            });

            // DG.marker([55.563984, 37.407784]).addTo(map).bindPopup('Вы кликнули по мне!');
            // // создает ломаную красного цвета из массива точек LatLng
            // var latlngs = [
            //     [55.565657, 37.408957],
            //     [55.565885, 37.409588]
            // ];
            // var polyline = DG.polyline(latlngs, {color: 'red'}).addTo(map);

            // создает красный многоугольник из массива точек LatLng
            // var latlngs = [[55.566431, 37.410476],[55.566558, 37.410292],
            //                 [55.566650, 37.410490],[55.566524, 37.410674]];
            // var polygon = DG.polygon(latlngs, {color: 'red'}).addTo(map);
            // увеличиваем масштаб так, чтобы было видно всю ломаную
            // map.fitBounds(polyline.getBounds());
        });

        function drawBuild(polygons) {
            if (Array.isArray(polygons[0][0])){
                drawBuild(polygons[0]);
            } else {
                var latlngs = polygons
                DG.polygon(latlngs, {color: 'blue'}).addTo(map);
            }
        }

        function drawStreets(line) {
            var latlngs = line;
            DG.polyline(latlngs, {color: 'blue'}).addTo(map);
        }

    </script>

    <style>
        body {
            display: flex;
            height: 100vh;
            width: 100vw;
            margin: 0;
        }
        #map {
            margin: auto;
            height: calc(100% - 50px);
            width: calc(100% - 50px);
        }
    </style>
</head>
<body>
    <div id="map"></div>
</body>
<script>
    async function fetchData() {
        try {
            const response = await fetch("/data");
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = (await response.json()).data;

            if (data.polygons) {
                data.polygons.features.forEach(feature => {
                    // console.log(feature);
                    drawBuild(feature.properties.coordinates);
                });
            }

            // for (let i = 0; i < 100; ++i) {
            //     drawStreets(data.lines.features[i]);
            // }

            // console.log(data.lines);
            if (data.lines) {
                data.lines.features.forEach(feature => {
                    // console.log(feature);
                    drawStreets(feature.properties.coordinates);
                });
            }

            console.log(data.lines);
        } catch (error) {
            console.error('Error fetching data:', error);
        }
    }

    // Вызов функции для получения данных при загрузке страницы
    fetchData();
</script>
</html>